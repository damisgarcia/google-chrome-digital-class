function moduleDidLoad(){var $desktopInRecorder;chrome.runtime.onConnect.addListener(function(port){port.onMessage.addListener(function(res){if("status"==res.action)port.postMessage({status:DigitalClass.situation});else if("stop records"==res.action)Encoder.stopRecords();else if("take stream records"==res.action){var camera=StreamHelper.to_url(DigitalClass.camStream),desktop=StreamHelper.to_url(DigitalClass.desktopStream),mic=StreamHelper.to_url(DigitalClass.micStream);port.postMessage({action:"take stream records",$camera:camera,$desktop:desktop,$mic:mic,desktop_is_focus:$desktopInRecorder,status:DigitalClass.situation})}else if("desktop request stream"==res.action)getUserScreen.getDesktop(function(stream){function onstop(){checkout(filename)}DigitalClass.desktopStream=stream;var filename=DigitalClass.$generateFileName(),options={filename:filename,width:window.screen.width,height:window.screen.height,saveDisk:!0},response=Encoder.start(stream,null,options,onstop);port.postMessage({action:"desktop request stream",stream:response,status:DigitalClass.situation})});else if("webcam request stream"==res.action)getUserMedia.getWebCam(function(stream){function onstop(){checkout(filename)}DigitalClass.camStream=stream;var filename=DigitalClass.$generateFileName(),options={filename:filename,width:640,height:480,saveDisk:!0},response=Encoder.start(stream,null,options,onstop);port.postMessage({action:"webcam request stream",stream:response,status:DigitalClass.situation})});else if("desktop with camera request stream"==res.action){var filename=DigitalClass.$generateFileName();getUserScreen.getDesktop(function(stream){DigitalClass.desktopStream=stream,getUserMedia.getWebCam(function(stream){function onstop(){checkout(filename)}DigitalClass.camStream=stream;var options={filename:filename,width:window.screen.width,height:window.screen.height},response=Encoder.start(DigitalClass.desktopStream,DigitalClass.camStream,options,onstop);port.postMessage({action:"webcam request stream",stream:response,status:DigitalClass.situation})}),$desktopInRecorder=!0})}else if("focus desktop"==res.action){var desktop_track=DigitalClass.desktopStream.getVideoTracks()[0];Encoder.updateTrack(desktop_track),$desktopInRecorder=!0}else if("focus webcam"==res.action){var webmcam_track=DigitalClass.camStream.getVideoTracks()[0];Encoder.updateTrack(webmcam_track),$desktopInRecorder=!1}else"repositories list"==res.action?fileSystem.list(function(repositories){port.postMessage({action:"repositories list",files:repositories.reverse()})}):"repositories show"==res.action?fileSystem.find_by_name(res.filename,function(f){port.postMessage({action:"repositories show",file:f})}):"repositories edit"==res.action?fileSystem.mvdir(res.past_name,res.new_name,function(repository){fileSystem.$list(repository,function(result){port.postMessage({action:"repositories list",files:result.reverse()})})}):"repositories show media-group"==res.action?fileSystem.open(res.target,function(result){port.postMessage({action:"repositories show media-group",media_group:result,parent:res.target})}):"repositories destroy"==res.action?fileSystem.rmdir(res.target,function(f){fileSystem.list(function(repositories){port.postMessage({action:"repositories list",files:repositories.reverse()})})}):"repositories markfolder"==res.action&&fileSystem.save(res.target+"/synchronized.txt",new Blob(["Synchronized"],{type:"text/plain"}))})})}function checkout(filename){var formats=[".webm",".wav",".png"],files=[],redirect=filename;formats.forEach(function(format){fileSystem.find_by_name(filename+format,function(f){files.push(f)})}),moveCaptures(filename,files),callRepositoryWindow(redirect)}function callRepositoryWindow(filename){setTimeout(function(){chrome.tabs.create({url:"/index.html#/repositories/"+filename},null)},RELOAD_WAIT)}function moveCaptures(dirname,array_files){fileSystem.mkdir(dirname,function(DataFolder){array_files.forEach(function(file){PNG_REGEX.test(file.$name)?file.moveTo(DataFolder,"poster.png"):WEBM_REGEX.test(file.$name)?file.moveTo(DataFolder,"video.webm"):WAV_REGEX.test(file.$name)?file.moveTo(DataFolder,"audio.wav"):file.moveTo(DataFolder)})})}var isTest=!1,isRelease=!0,common=function(){function isHostToolchain(tool){return"win"==tool||"linux"==tool||"mac"==tool}function mimeTypeForTool(tool){var mimetype="application/x-nacl";return isHostToolchain(tool)?mimetype=isRelease?"application/x-ppapi-release":"application/x-ppapi-debug":"pnacl"==tool&&(mimetype="application/x-pnacl"),mimetype}function browserSupportsNaCl(tool){if(isHostToolchain(tool))return!0;var mimetype=mimeTypeForTool(tool);return void 0!==navigator.mimeTypes[mimetype]}function injectScript(url,onload,onerror){var scriptEl=document.createElement("script");scriptEl.type="text/javascript",scriptEl.src=url,scriptEl.onload=onload,onerror&&scriptEl.addEventListener("error",onerror,!1),document.head.appendChild(scriptEl)}function runTests(moduleEl){console.log("runTests()"),common.tester=new Tester,common.tester.exitCleanlyIsOK(),common.tester.addAsyncTest("loaded",function(test){test.pass()}),"undefined"!=typeof window.addTests&&window.addTests(),common.tester.waitFor(moduleEl),common.tester.run()}function createNaClModule(name,tool,path,width,height,attrs){navigator.webkitPersistentStorage.requestQuota(1073741824,function(bytes){console.log("Allocated "+bytes+" bytes of persistant storage.")},function(e){console.log("Failed to allocate space")});var moduleEl=document.createElement("embed");if(moduleEl.setAttribute("name","nacl_module"),moduleEl.setAttribute("id","nacl_module"),moduleEl.setAttribute("width",width),moduleEl.setAttribute("height",height),moduleEl.setAttribute("path",path),moduleEl.setAttribute("src",path+"/"+name+".nmf"),attrs)for(var key in attrs)moduleEl.setAttribute(key,attrs[key]);var mimetype=mimeTypeForTool(tool);moduleEl.setAttribute("type",mimetype);var listenerDiv=document.getElementById("listener");listenerDiv.appendChild(moduleEl),moduleEl.offsetTop;var isHost=isHostToolchain(tool);if(isHost&&window.setTimeout(function(){moduleEl.readyState=1,moduleEl.dispatchEvent(new CustomEvent("loadstart")),moduleEl.readyState=4,moduleEl.dispatchEvent(new CustomEvent("load")),moduleEl.dispatchEvent(new CustomEvent("loadend"))},100),isTest){var loadNaClTest=function(){injectScript("nacltest.js",function(){runTests(moduleEl)})};injectScript("test.js",loadNaClTest,loadNaClTest)}}function attachDefaultListeners(){var listenerDiv=document.getElementById("listener");listenerDiv.addEventListener("load",moduleDidLoad,!0),listenerDiv.addEventListener("message",handleMessage,!0),listenerDiv.addEventListener("error",handleError,!0),listenerDiv.addEventListener("crash",handleCrash,!0),"undefined"!=typeof window.attachListeners&&window.attachListeners()}function handleError(event){var moduleEl=document.getElementById("nacl_module");updateStatus("ERROR ["+moduleEl.lastError+"]")}function handleCrash(event){updateStatus(-1==common.naclModule.exitStatus?"CRASHED":"EXITED ["+common.naclModule.exitStatus+"]"),"undefined"!=typeof window.handleCrash&&window.handleCrash(common.naclModule.lastError)}function moduleDidLoad(){common.naclModule=document.getElementById("nacl_module"),updateStatus("RUNNING"),"undefined"!=typeof window.moduleDidLoad&&window.moduleDidLoad()}function hideModule(){common.naclModule.style.height="0"}function removeModule(){common.naclModule.parentNode.removeChild(common.naclModule),common.naclModule=null}function startsWith(s,prefix){return 0===s.lastIndexOf(prefix,0)}function logMessage(message){logMessageArray.push(message),logMessageArray.length>kMaxLogMessageLength&&logMessageArray.shift(),console.log(message)}function handleMessage(message_event){if("string"==typeof message_event.data)for(var type in defaultMessageTypes)if(defaultMessageTypes.hasOwnProperty(type)&&startsWith(message_event.data,type+":"))return func=defaultMessageTypes[type],void func(message_event.data.slice(type.length+1));return"undefined"!=typeof window.handleMessage?void window.handleMessage(message_event):void logMessage("Unhandled message: "+message_event.data)}function domContentLoaded(name,tool,path,width,height,attrs){updateStatus("Page loaded."),browserSupportsNaCl(tool)?null==common.naclModule?(updateStatus("Creating embed: "+tool),width="undefined"!=typeof width?width:200,height="undefined"!=typeof height?height:200,attachDefaultListeners(),createNaClModule(name,tool,path,width,height,attrs)):updateStatus("Waiting."):updateStatus("Browser does not support NaCl ("+tool+"), or NaCl is disabled")}function updateStatus(opt_message){opt_message&&(statusText=opt_message);var statusField=document.getElementById("statusField");statusField&&(statusField.innerHTML=statusText)}var kMaxLogMessageLength=20,logMessageArray=[],defaultMessageTypes={alert:alert,log:logMessage},statusText="NO-STATUSES";return{naclModule:null,attachDefaultListeners:attachDefaultListeners,domContentLoaded:domContentLoaded,createNaClModule:createNaClModule,hideModule:hideModule,removeModule:removeModule,logMessage:logMessage,updateStatus:updateStatus}}();document.addEventListener("DOMContentLoaded",function(){var body=document.body;if(body.dataset){var loadFunction;body.dataset.customLoad?"undefined"!=typeof window.domContentLoaded&&(loadFunction=window.domContentLoaded):loadFunction=common.domContentLoaded;var searchVars={};if(window.location.search.length>1)for(var pairs=window.location.search.substr(1).split("&"),key_ix=0;key_ix<pairs.length;key_ix++){var keyValue=pairs[key_ix].split("=");searchVars[unescape(keyValue[0])]=keyValue.length>1?unescape(keyValue[1]):""}if(loadFunction){var toolchains=body.dataset.tools.split(" "),configs=body.dataset.configs.split(" "),attrs={};if(body.dataset.attrs){var attr_list=body.dataset.attrs.split(" ");for(var key in attr_list){var attr=attr_list[key].split("="),key=attr[0],value=attr[1];attrs[key]=value}}var tc=-1!==toolchains.indexOf(searchVars.tc)?searchVars.tc:toolchains[0];if(-1!==configs.indexOf(searchVars.config))var config=searchVars.config;else if(-1!==configs.indexOf("Release"))var config="Release";else var config=configs[0];var pathFormat=body.dataset.path,path=pathFormat.replace("{tc}",tc).replace("{config}",config);isTest="true"===searchVars.test,isRelease=-1!=path.toLowerCase().indexOf("release"),loadFunction(body.dataset.name,tc,path,body.dataset.width,body.dataset.height,attrs)}}});var DigitalClass=function(){var self={};return self.filesystem="filesystem:"+location.origin+"/persistent/",self.status={done:0,recording:1,paused:2,success:3,fail:4},self.situation=self.status.done,self.popup=null,self.popupOptions={type:"popup",width:320,height:240,top:window.screen.availHeight,left:window.screen.availWidth},self.camStream=null,self.desktopStream=null,self.micStream=null,self.$closeTab=function(id){chrome.windows.remove(id,null)},self.$generateFileName=function(){var basename=(new Date).toLocaleString().replace(/ /g,"_");return basename=basename.replace(/[\/:]/g,"-")},self}(DigitalClass),getUserScreen=function(){var self={};return self.getDesktop=function(callback,onFail){chrome.desktopCapture.chooseDesktopMedia(["window","screen"],function(desktop_id){navigator.webkitGetUserMedia({audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:desktop_id,maxWidth:window.screen.width,maxHeight:window.screen.height}}},callback,onFail||self.fail)})},self.fail=function(error){console.debug(error),DigitalClass.situation=DigitalClass.status.done},self}(getUserScreen),getUserMedia=function(){var self={};return self.getWebCam=function(callback,onFail){navigator.webkitGetUserMedia({video:!0},callback,onFail||self.fail)},self.fail=function(error){DigitalClass.situation=DigitalClass.status.done},self}(getUserMedia,window),Microphone=function(){function getBuffers(event){for(var buffers=[],ch=0;2>ch;++ch)buffers[ch]=event.inputBuffer.getChannelData(ch);return buffers}function startRecordingProcess(){var bufSz=BUFFER_SIZE,quality=QUALITY;processor=audioContext.createScriptProcessor(bufSz,2,2),input.connect(processor),processor.connect(audioContext.destination),worker.postMessage({command:"start",process:"separate",sampleRate:audioContext.sampleRate,numChannels:2,quality:quality}),processor.onaudioprocess=function(event){worker.postMessage({command:"record",buffers:getBuffers(event)})}}function stopRecordingProcess(){input.disconnect(),processor.disconnect(),worker.postMessage({command:"finish"})}function onUserGetMediaStreamSuccess(stream){microphone=audioContext.createMediaStreamSource(stream),microphone.connect(microphoneLevel),startRecordingProcess(),DigitalClass.micStream=stream}function onUserGetMediaStreamFail(error){console.log(error)}function garbageCollector(){null!=DigitalClass.micStream&&DigitalClass.micStream&&DigitalClass.micStream.getAudioTracks().forEach(function(track){track.stop()})}var audioContext=new AudioContext;null==audioContext.createScriptProcessor&&(audioContext.createScriptProcessor=audioContext.createJavaScriptNode);var microphone,microphone=void 0,microphoneLevel=audioContext.createGain(),mixer=audioContext.createGain(),input=audioContext.createGain(),processor=void 0,mandatory={mandatory:{echoCancellation:!1,googAutoGainControl:!0,googNoiseSuppression:!0,googHighpassFilter:!0,googTypingNoiseDetection:!0},optional:[{googAudioMirroring:!1}]};microphoneLevel.gain.value=.5,microphoneLevel.connect(mixer),mixer.connect(input);var BUFFER_SIZE=2048,QUALITY=.2,worker=new Worker("/app/scripts/services/lib/OggEncoderWorker.js"),self={};return self.startRecordingProcess=function(callback,onStop){navigator.webkitGetUserMedia({audio:mandatory},onUserGetMediaStreamSuccess,onUserGetMediaStreamFail)},self.stopRecordingProcess=function(callback){if(!callback)throw"Callback is not defined.";worker.onmessage=function(event){callback(event.data.blob),garbageCollector()},stopRecordingProcess()},self}(Microphone,window),WAIT_TIME_STOP_RECORDS=600,Encoder=function(){var self={};return self.start=function(m_stream,bg_stream,options,onStop){if(!options)throw"Not found options";if(!m_stream)throw"Main stream is not null";DigitalClass.situation=DigitalClass.status.recording;var m_blob_url=URL.createObjectURL(m_stream),m_track=m_stream.getVideoTracks()[0],main=document.createElement("video");if(main.src=m_blob_url,main.width=options.width,main.height=options.height,main.track=m_track,main.play(),main.onplay=function(){var max=3e3,min=1e3,timeoutTakeAPhoto=Math.random()*(max-min)+min;setTimeout(function(){var framename=options.filename+".png";self.saveFrame(main,framename)},timeoutTakeAPhoto)},main.track.onended=function(){self.stop(onStop),main=!1},bg_stream){var bg_blob_url=URL.createObjectURL(bg_stream),bg_track=bg_stream.getVideoTracks()[0],bg=document.createElement("video");bg.src=m_blob_url,bg.width=640,bg.height=480,bg.track=bg_track,bg.play()}var naclOptions={command:"start",file_name:options.filename+".webm",profile:"vp8",width:main.width,height:main.height};bg_track?naclOptions.video_track=m_track:naclOptions.video_track=m_track,common.naclModule.postMessage(naclOptions),Microphone.filename=options.filename+".wav",Microphone.startRecordingProcess();var response={main:{video:main,src:m_blob_url}};return bg_stream&&(response.bg={video:bg,src:bg_blob_url}),response},self.stop=function(callback){DigitalClass.situation!=DigitalClass.status.paused&&(Microphone.stopRecordingProcess(function(blob){fileSystem.save(Microphone.filename,blob,callback),DigitalClass.situation=DigitalClass.status.done}),self.stopRecords())},self.stopRecords=function(){null!=DigitalClass.camStream&&DigitalClass.camStream.active&&DigitalClass.camStream.getVideoTracks().forEach(function(track){track.stop()}),null!=DigitalClass.desktopStream&&DigitalClass.desktopStream.active&&DigitalClass.desktopStream.getVideoTracks().forEach(function(track){track.stop()}),setTimeout(function(){common.naclModule.postMessage({command:"stop"})},WAIT_TIME_STOP_RECORDS),DigitalClass.situation=DigitalClass.status.paused},self.updateTrack=function(track){common.naclModule.postMessage({command:"change_track",video_track:track})},self.getFrame=function(element){var canvas=document.createElement("canvas");canvas.width=element.width,canvas.height=element.height;var ctx=canvas.getContext("2d");ctx.drawImage(element,0,0);var base64=canvas.toDataURL("image/png",.1).replace("data:image/png;base64,",""),blob=StreamHelper.b64toBlob(base64,"image/png");return blob},self.saveFrame=function(video,filename){var frame=self.getFrame(video);fileSystem.save(filename,frame)},self.reload=function(){window.location.reload()},self}(Encoder),fileSystem=function(){var self={};return self.$1MB=1024,self.$10MB=self.$1MB*self.$1MB,self.$1GB=self.$10MB*self.$1MB,self.$2GB=self.$10MB*(2*self.$1MB),self.$5GB=self.$10MB*(5*self.$1MB),self.$10GB=2*self.$5GB,self.basename="filesystem:"+location.origin+"/persistent",self.list=function(callback){navigator.webkitPersistentStorage.requestQuota(self.$1GB,function(){window.webkitRequestFileSystem(window.PERSISTENT,self.$1GB,function(persistent){self.$list(persistent,callback)})})},self.find_by_name=function(filename,callback){if(!callback)throw"Error: Not found return function";navigator.webkitPersistentStorage.requestQuota(self.$1GB,function(){window.webkitRequestFileSystem(window.PERSISTENT,self.$1GB,function(persistent){self.$find_by_name(persistent,filename,callback)})})},self.save=function(filename,blob,callback){navigator.webkitPersistentStorage.requestQuota(self.$1GB,function(){window.webkitRequestFileSystem(window.PERSISTENT,self.$1GB,function(persistent){self.$save(persistent,filename,blob,callback)})})},self.destroy=function(file,callback){file.remove(callback,self.$errorHandler)},self.$find_by_name=function(repository,filename,callback){repository.root.getFile(filename,{create:!1},function(DatFile){self.$appendPublicAttributesToFile(DatFile),callback(DatFile)})},self.$save=function(repository,filename,blob,callback){repository.root.getFile(filename,{create:!0},function(DatFile){DatFile.createWriter(function(DatContent){DatContent.write(blob)}),callback&&callback()})},self.open=function(dirname,callback){navigator.webkitPersistentStorage.requestQuota(self.$1GB,function(){window.webkitRequestFileSystem(window.PERSISTENT,self.$1GB,function(persistent){self.$open(persistent,dirname,callback)})})},self.mkdir=function(dirname,callback){navigator.webkitPersistentStorage.requestQuota(self.$1GB,function(){window.webkitRequestFileSystem(window.PERSISTENT,self.$1GB,function(persistent){self.$mkdir(persistent,dirname,callback)})})},self.mvdir=function(dirname,newDirName,callback){if(!callback)throw"Error: Not found return function";navigator.webkitPersistentStorage.requestQuota(self.$1GB,function(){window.webkitRequestFileSystem(window.PERSISTENT,self.$1GB,function(persistent){self.$mvdir(persistent,dirname,newDirName,callback)})})},self.rmdir=function(dirname,callback){navigator.webkitPersistentStorage.requestQuota(self.$1GB,function(){window.webkitRequestFileSystem(window.PERSISTENT,self.$1GB,function(persistent){self.$rmdir(persistent,dirname,callback)})})},self.$mkdir=function(repository,dirname,callback){repository.root.getDirectory(dirname,{create:!0},callback)},self.$rmdir=function(repository,dirname,callback){if(!callback)throw"Error: Not found return function";repository.root.getDirectory(dirname,{create:!1},function(repository){repository.removeRecursively(callback,function(error){console.error(error)})})},self.$mvdir=function(repository,dirname,newDirName,callback){repository.root.getDirectory(dirname,{create:!1},function(dir){dir.moveTo(repository.root,newDirName,callback,function(error){console.error(error)})})},self.$open=function(repository,dirname,callback){repository.root.getDirectory(dirname,{create:!1},function(repository){self.$list(repository,callback)})},self.$list=function(repository,callback){if(!callback)throw"Error: Not found return function";var root=repository.root||repository,dirReader=root.createReader(),entries=[],readEntries=function(){dirReader.readEntries(function(results){results.length?(results.forEach(function(file){self.$appendPublicAttributesToFile(file)}),entries=entries.concat(self.$toArray(results)),readEntries()):callback(entries.reverse())},function(error){console.log(error)})};readEntries()},self.$appendPublicAttributesToFile=function(file){file.extensionPath=self.basename+file.fullPath,file.$name=file.name},self.$toArray=function(list){return Array.prototype.slice.call(list||[],0)},self.$errorHandler=function(error){console.debug(error)},self}(fileSystem,window),StreamHelper=function(){var self={};return self.to_url=function(stream){try{return URL.createObjectURL(stream)}catch(e){return null}},self.b64toBlob=function(b64Data,contentType,sliceSize){contentType=contentType||"",sliceSize=sliceSize||512;for(var byteCharacters=atob(b64Data),byteArrays=[],offset=0;offset<byteCharacters.length;offset+=sliceSize){for(var slice=byteCharacters.slice(offset,offset+sliceSize),byteNumbers=new Array(slice.length),i=0;i<slice.length;i++)byteNumbers[i]=slice.charCodeAt(i);var byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray)}var blob=new Blob(byteArrays,{type:contentType});return blob},self}(StreamHelper),RELOAD_WAIT=3e3,PNG_REGEX=/\.png$/,WEBM_REGEX=/\.webm$/,WAV_REGEX=/\.wav$/;